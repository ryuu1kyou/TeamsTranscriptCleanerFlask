{% extends "base.html" %}

{% block title %}{{ _('Teams Transcript Cleaner') }}{% endblock %}

{% block content %}
{% set is_en = (session.get('language') or get_locale()) == 'en' %}
<div class="row vh-100">
    <!-- Left Sidebar: Settings Panel (Resizable) -->
    <div class="border-end overflow-auto position-relative d-flex flex-column" id="leftPanel" style="min-width: 250px; width: 300px;">
        <div class="p-3 flex-grow-1">
    <h6 class="text-danger mb-3">{{ _('設定') }}</h6>
      
      <div class="alert alert-success py-2" role="alert">
        <small>{{ _('OpenAI APIキーが設定されています') }}</small>
      </div>
      
      <div class="mb-4">
    <h6>{{ _('コスト情報') }}</h6>
        <div class="bg-light p-2 rounded mb-2">
          <small class="text-primary">{{ _('累計使用コスト') }}: ${{ "%.5f" | format(current_user.total_api_cost) }} USD</small>
        </div>
        <div class="bg-light p-2 rounded mb-2">
          <small class="text-primary" id="sessionCostDisplay">{{ _('現在のセッションコスト') }}: $0.00000 USD</small>
        </div>
    <button class="btn btn-sm btn-outline-secondary w-100" onclick="resetSessionCost()">{{ _('コスト履歴をリセット') }}</button>
      </div>
      
      <div class="mb-4">
    <h6>{{ _('OpenAIモデル選択') }}</h6>
        <select class="form-select form-select-sm" id="modelSelect">
          <option value="gpt-4o">GPT-4o</option>
          <option value="gpt-4o-mini">GPT-4o Mini</option>
          <option value="gpt-4-turbo">GPT-4 Turbo</option>
        </select>
        <small class="text-muted d-block mt-1" id="pricingInfo">
          {{ _('料金') }}: $0.000 / 1000 {{ _('トークン') }}
        </small>
      </div>
      
      <div class="mb-4">
    <h6>{{ _('処理モード選択') }}</h6>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="processingMode" id="proofreading" value="proofreading" checked>
          <label class="form-check-label" for="proofreading">
            <small>{{ _('誤字脱字修正') }}</small>
          </label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="processingMode" id="grammar" value="grammar">
          <label class="form-check-label" for="grammar">
            <small>{{ _('文法修正') }}</small>
          </label>
        </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="processingMode" id="summary" value="summary">
                    <label class="form-check-label" for="summary">
                        <small>{{ _('要約') }}</small>
                    </label>
                </div>
            </div>
            <div class="mb-4">
                <h6>{{ _('追加の指示（モードに応じて入力）') }}</h6>
                <textarea class="form-control" rows="3" id="customPrompt" placeholder="{{ _('例：誤字脱字モード『特』に入れ込み要素に確認し、要約モード『130文字以内で箇条書きで』') }}"></textarea>
            </div>
            <div class="mb-4">
                <h6>{{ _('議事録 (TXT) アップロード') }}</h6>
                <div class="border border-dashed rounded p-2 text-center mb-2" style="min-height: 80px;">
                    <small class="d-block">{{ _('Drag and drop file here') }}</small>
                    <small class="text-muted">{{ _('Limit 200MB per file • TXT') }}</small>
                    <input type="file" id="txtFile" accept=".txt" style="display: none;">
                    <button class="btn btn-sm btn-outline-primary mt-1" onclick="document.getElementById('txtFile').click()">{{ _('Browse files') }}</button>
                </div>
            </div>
            <div class="mb-4">
                <h6>{{ _('誤字脱字一覧 (CSV) アップロード') }}</h6>
                <div class="border border-dashed rounded p-2 text-center" style="min-height: 80px;">
                    <small class="d-block">{{ _('Drag and drop file here') }}</small>
                    <small class="text-muted">{{ _('Limit 200MB per file • CSV') }}</small>
                    <input type="file" id="csvFile" accept=".csv" style="display: none;">
                    <button class="btn btn-sm btn-outline-primary mt-1" onclick="document.getElementById('csvFile').click()">{{ _('Browse files') }}</button>
                </div>
            </div>
        </div>
        <!-- Bottom action buttons (fixed at bottom) -->
        <div class="p-3 border-top mt-auto">
            <button class="btn btn-outline-success w-100 mb-2" onclick="toggleTranscriptHistory()">
                <i class="fas fa-history me-1"></i>{{ _('議事録修正履歴') }}
            </button>
            {% if current_user.can_manage_users() %}
            <button class="btn btn-outline-info w-100" onclick="toggleUserManagement()">
                <i class="fas fa-cog me-1"></i>{{ _('管理') }}
            </button>
            {% endif %}
        </div>
        <!-- Resize Handle -->
        <div class="position-absolute top-0 end-0 h-100 bg-primary" 
                 id="resizeHandle" 
                 style="width: 4px; cursor: col-resize; opacity: 0.3;"
                 onmouseenter="this.style.opacity='1'"
                 onmouseleave="this.style.opacity='0.3'">
        </div>
    </div>

    <!-- Right Panel -->
    <div class="flex-fill d-flex flex-column overflow-hidden" id="rightPanel">
        <div class="d-flex justify-content-between align-items-center p-3 border-bottom flex-shrink-0">
            <h4 class="mb-0 text-primary">Teams Transcript Cleaner</h4>
            <div class="d-flex align-items-center">
                <small class="me-3">{{ _('ユーザー') }}: {{ current_user.full_name or current_user.username }}</small>
                <a href="{{ url_for('auth.logout') }}" class="btn btn-outline-secondary btn-sm me-2">{{ _('ログアウト') }}</a>
                <button id="backToMainBtn" class="btn btn-outline-primary btn-sm" style="display:none;" onclick="showMainScreen()">
                    <i class="fas fa-home me-1"></i>{{ _('メイン画面') }}
                </button>
            </div>
        </div>

        <div class="flex-fill p-3 overflow-auto" id="mainContent">
            <div class="row h-100">
                <div class="col-6">
                    <div class="h-100 d-flex flex-column">
                        <h5 class="mb-2">{{ _('訂正前のファイル内容（編集不可）') }}</h5>
                        <div class="flex-fill bg-light border rounded p-3 overflow-auto">
                            <textarea class="form-control h-100 border-0 bg-transparent resize-none" id="originalContent" readonly placeholder="{{ _('テキストファイルをアップロードしてください') }}" style="resize: none;"></textarea>
                        </div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="h-100 d-flex flex-column">
                        <h5 class="mb-2">{{ _('訂正後のファイル内容（手修正可）') }}</h5>
                        <div class="flex-fill bg-light border rounded p-3 overflow-auto">
                            <textarea class="form-control h-100 border-0 bg-transparent resize-none" id="correctedContent" placeholder="{{ _('訂正実行後に結果が表示されます') }}" style="resize: none;"></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="flex-fill p-3 overflow-auto" id="transcriptHistoryContent" style="display:none;">
      <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="mb-0">{{ _('議事録修正履歴') }}</h4>
        <div>
          <button class="btn btn-outline-secondary btn-sm" onclick="showMainScreen()">
            <i class="fas fa-arrow-left me-1"></i>{{ _('戻る') }}
          </button>
        </div>
      </div>
      <div class="card h-100">
        <div class="card-header">
          <h5 class="mb-0">{{ _('議事録一覧') }}</h5>
        </div>
        <div class="card-body overflow-auto">
          <div id="transcriptHistoryList" class="small text-muted">{{ _('読み込み中...') }}</div>
        </div>
      </div>
    </div>

    <div class="flex-fill p-3 overflow-auto" id="userManagementContent" style="display:none;">
      <!-- Tab Navigation -->
      <ul class="nav nav-tabs mb-3" id="managementTabs">
        <li class="nav-item">
          <button class="nav-link active" id="userTab" onclick="switchTab('user')">
            <i class="fas fa-users me-1"></i>{{ _('ユーザー管理') }}
          </button>
        </li>
        <li class="nav-item">
          <button class="nav-link" id="roleTab" onclick="switchTab('role')">
            <i class="fas fa-shield-alt me-1"></i>{{ _('ロール管理') }}
          </button>
        </li>
      </ul>
      
      <!-- User Management Tab -->
      <div class="tab-content h-100">
        <div class="tab-pane fade show active h-100" id="userTabContent">
          <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="mb-0">{{ _('ユーザー一覧') }}</h5>
              <button class="btn btn-primary btn-sm" onclick="addUser()">
                <i class="fas fa-plus me-1"></i>{{ _('新規ユーザー追加') }}
              </button>
            </div>
            <div class="card-body overflow-auto">
              <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>ID</th>
                                            <th>{{ _('ユーザー名') }}</th>
                                            <th>{{ _('メール') }}</th>
                                            <th>{{ _('ロール') }}</th>
                                            <th>{{ _('最終ログイン') }}</th>
                                            <th>{{ _('ステータス') }}</th>
                                            <th>{{ _('アクション') }}</th>
                                        </tr>
                                    </thead>
                  <tbody id="userTableBody">
                    <!-- User data will be loaded here -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Role Management Tab -->
        <div class="tab-pane fade h-100" id="roleTabContent">
          <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="mb-0">ロール管理</h5>
                            <button class="btn btn-primary btn-sm" onclick="addRole()">
                                <i class="fas fa-plus me-1"></i>{{ _('新規ロール追加') }}
                            </button>
            </div>
            <div class="card-body overflow-auto">
              <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>{{ _('ロール名') }}</th>
                                            <th>{{ _('説明') }}</th>
                                            <th>{{ _('権限') }}</th>
                                            <th>{{ _('ユーザー数') }}</th>
                                            <th>{{ _('作成日') }}</th>
                                            <th class="text-nowrap">{{ _('アクション') }}</th>
                                        </tr>
                                    </thead>
                  <tbody id="roleTableBody">
                    <!-- Role data will be loaded here -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
        <!-- Modals -->
        <div class="modal fade" id="userModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="userModalTitle"></h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="userForm">
                            <input type="hidden" id="userIdField">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label small">{{ _('ユーザー名') }}</label>
                                    <input type="text" class="form-control" id="usernameField" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label small">{{ _('メール') }}</label>
                                    <input type="email" class="form-control" id="emailField" required>
                                </div>
                                <div class="col-md-6" id="passwordGroup">
                                    <label class="form-label small">{{ _('パスワード') }}</label>
                                    <input type="password" class="form-control" id="passwordField" autocomplete="new-password">
                                    <small class="text-muted" id="passwordHelp"></small>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label small">{{ _('ロール') }}</label>
                                    <select class="form-select" id="roleSelect"></select>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check mt-4">
                                        <input class="form-check-input" type="checkbox" id="isActiveField" checked>
                                        <label class="form-check-label small" for="isActiveField">{{ _('アクティブ') }}</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check mt-4">
                                        <input class="form-check-input" type="checkbox" id="isVerifiedField">
                                        <label class="form-check-label small" for="isVerifiedField">{{ _('検証済み') }}</label>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('閉じる') }}</button>
                        <button type="button" class="btn btn-primary" id="saveUserBtn"></button>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="roleModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="roleModalTitle"></h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="roleForm">
                            <input type="hidden" id="roleIdField">
                            <div class="mb-3">
                                <label class="form-label small">{{ _('ロール名') }}</label>
                                <input type="text" class="form-control" id="roleNameField" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label small">{{ _('説明') }}</label>
                                <textarea class="form-control" id="roleDescriptionField" rows="2"></textarea>
                            </div>
                            <div class="border rounded p-2 mb-2">
                                <label class="form-label small mb-2">{{ _('権限') }}</label>
                                <div class="row g-2 small">
                                    <div class="col-6">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="permManageUsers">
                                            <label class="form-check-label" for="permManageUsers">{{ _('ユーザー管理') }}</label>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="permManageRoles">
                                            <label class="form-check-label" for="permManageRoles">{{ _('ロール管理') }}</label>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="permViewAll">
                                            <label class="form-check-label" for="permViewAll">{{ _('全体閲覧') }}</label>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="permUseApi" checked>
                                            <label class="form-check-label" for="permUseApi">API</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('閉じる') }}</button>
                        <button type="button" class="btn btn-primary" id="saveRoleBtn"></button>
                    </div>
                </div>
            </div>
        </div>
    
        <div class="p-3 border-top flex-shrink-0" id="mainButtons">
      <div class="row">
        <div class="col-6">
                    <button class="btn btn-secondary w-100" id="copyToCorrectedBtn" disabled onclick="copyToCorrected()">
                        {{ _('訂正後テキストを訂正前にコピー') }}
                    </button>
        </div>
        <div class="col-6">
                    <button class="btn btn-outline-secondary w-100" id="downloadBtn" disabled onclick="downloadResult()">
                        {{ _('最終確定をダウンロード') }}
                    </button>
        </div>
      </div>
    </div>
    </div> <!-- /rightPanel -->
</div> <!-- /row -->

<!-- Hidden Process Button (triggered by file upload) -->
<button id="processBtn" style="display: none;" onclick="processText()">Process</button>

<!-- Stats and Diff Display (hidden by default) -->
<div id="statsDisplay" style="display: none;">
  <small id="originalStats">文字数: 0, 単語数: 0</small>
  <small id="correctedStats">訂正実行後に統計が表示されます</small>
</div>

<div id="diffDisplay" style="display: none;">
  <div class="card">
    <div class="card-header">
      <h5 class="mb-0">差分表示</h5>
    </div>
    <div class="card-body">
      <div id="diffContent"></div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let sessionCost = 0.0;
let originalText = '';
let correctedText = '';
let selectedWordlistId = null;
let activeTranscriptId = null; // Set after first TXT upload

// i18n message dictionary injected from server-side using gettext
const MSG = {
    transcript_created: "{{ _('Transcript created') }}",
    transcript_create_failed: "{{ _('Failed to create transcript') }}",
    upload_text_prompt: "{{ _('Please upload a text file') }}",
    processing_running: "{{ _('Processing...') }}",
    processing_button_label: "{{ _('Run Processing') }}",
    processing_complete_prefix: "{{ _('Completed - Cost:') }}",
    processing_error_prefix: "{{ _('Processing error:') }}",
    text_copied: "{{ _('Copied text') }}",
    download_no_content: "{{ _('No content to download') }}",
    need_transcript_first: "{{ _('Upload transcript (TXT) first') }}",
    history_save_failed_prefix: "{{ _('Failed to save history:') }}",
    history_saved_and_downloaded: "{{ _('Saved final revision and downloaded') }}",
    load_error: "{{ _('Load error') }}",
    load_failed: "{{ _('Load failed') }}",
    user_created: "{{ _('User created') }}",
    user_updated: "{{ _('User updated') }}",
    role_created: "{{ _('Role created') }}",
    role_updated: "{{ _('Role updated') }}",
    required_missing: "{{ _('Required fields missing') }}",
    session_cost_reset: "{{ _('Session cost reset') }}",
    role_name_required: "{{ _('Role name required') }}",
    error_generic: "{{ _('Error') }}",
    unknown: "{{ _('Unknown') }}"
};

// File upload handlers
document.getElementById('txtFile').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(ev) {
        originalText = ev.target.result;
        document.getElementById('originalContent').value = originalText;
        updateOriginalStats();
        // Create transcript document on server for history association
        const baseName = file.name.replace(/\.[^.]+$/, '');
        fetch('/transcripts/api/upload', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title: baseName, filename: file.name, content: originalText })
        })
        .then(r=>r.json())
        .then(data=>{
            if(data.success){
                activeTranscriptId = data.transcript_id;
        showSuccess(MSG.transcript_created);
                processText();
            } else {
        showError(MSG.transcript_create_failed + ': ' + (data.error||''));
            }
        })
    .catch(err=> showError(MSG.transcript_create_failed + ': '+ err.message));
    };
    reader.readAsText(file);
});

document.getElementById('csvFile').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        // Upload CSV to create temporary wordlist
        const formData = new FormData();
        formData.append('file', file);
        formData.append('name', 'Temp_' + Date.now());
        formData.append('description', 'Temporary wordlist for processing');
        
        fetch('/wordlists/upload', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                selectedWordlistId = data.wordlist_id;
                showSuccess('CSVファイルが読み込まれました');
            } else {
                showError('CSVファイルの読み込みに失敗しました: ' + (data.error || '不明なエラー'));
            }
        })
        .catch(error => {
            showError('CSVファイルの読み込みに失敗しました: ' + error.message);
        });
    }
});

// Text processing
function processText() {
    if (!originalText) {
        showError(MSG.upload_text_prompt);
        return;
    }
    
    const processingMode = document.querySelector('input[name="processingMode"]:checked').value;
    const model = document.getElementById('modelSelect').value;
    const customPrompt = document.getElementById('customPrompt').value;
    
    // Show processing state
    const processBtn = document.getElementById('processBtn');
    processBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>' + MSG.processing_running;
    processBtn.disabled = true;
    
    // Make API call
    fetch('/api/process', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            content: originalText,
            processing_mode: processingMode,
            model_used: model,
            custom_prompt: customPrompt,
            wordlist_id: selectedWordlistId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            correctedText = data.corrected_text;
            document.getElementById('correctedContent').value = correctedText;
            updateCorrectedStats();
            
            // Update session cost
            sessionCost += parseFloat(data.cost);
            updateSessionCost();
            
            // Enable download button
            document.getElementById('downloadBtn').disabled = false;
            document.getElementById('copyToCorrectedBtn').disabled = false;
            
            showSuccess(`${MSG.processing_complete_prefix} $${data.cost.toFixed(5)}`);
            
            // Show diff if enabled
            if (document.getElementById('showDiff').checked) {
                showDiff();
            }
        } else {
            showError(`${MSG.processing_error_prefix} ${(data.error || 'Unknown')}`);
        }
    })
    .catch(error => {
        showError(`${MSG.processing_error_prefix} ${error.message}`);
    })
    .finally(() => {
        processBtn.innerHTML = '<i class="fas fa-magic me-1"></i>' + MSG.processing_button_label;
        processBtn.disabled = false;
    });
}

function copyToCorrected() {
    const correctedContent = document.getElementById('correctedContent').value;
    if (correctedContent) {
        originalText = correctedContent;
        document.getElementById('originalContent').value = originalText;
        updateOriginalStats();
    showSuccess(MSG.text_copied);
    }
}

function downloadResult() {
    const content = document.getElementById('correctedContent').value;
    if (!content) { showError(MSG.download_no_content); return; }
    if (!activeTranscriptId) { showError(MSG.need_transcript_first); return; }
    // First finalize (store revision), then download
    fetch('/transcripts/api/finalize', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ transcript_id: activeTranscriptId, content: content })
    })
    .then(r=>r.json())
    .then(data=>{
    if(!data.success){ showError(MSG.history_save_failed_prefix + ' ' + (data.error||'')); return; }
        const blob = new Blob([content], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = 'corrected_transcript.txt';
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        showSuccess(MSG.history_saved_and_downloaded);
    })
    .catch(err=> showError(MSG.history_save_failed_prefix + ' ' + err.message));
}

function showDiff() {
    if (!originalText || !correctedText) return;
    
    const diffDisplay = document.getElementById('diffDisplay');
    const diffContent = document.getElementById('diffContent');
    
    // Simple diff implementation
    const diff = createDiff(originalText, correctedText);
    diffContent.innerHTML = diff;
    diffDisplay.style.display = 'block';
}

function createDiff(original, corrected) {
    // Simple word-level diff
    const originalWords = original.split(/(\s+)/);
    const correctedWords = corrected.split(/(\s+)/);
    
    let result = '<pre style="white-space: pre-wrap; word-wrap: break-word;">';
    
    const maxLength = Math.max(originalWords.length, correctedWords.length);
    for (let i = 0; i < maxLength; i++) {
        const originalWord = originalWords[i] || '';
        const correctedWord = correctedWords[i] || '';
        
        if (originalWord !== correctedWord) {
            if (originalWord && !correctedWord) {
                result += `<span style="background-color: #ffdddd; text-decoration: line-through;">${originalWord}</span>`;
            } else if (!originalWord && correctedWord) {
                result += `<span style="background-color: #ddffdd;">${correctedWord}</span>`;
            } else {
                result += `<span style="background-color: #ffdddd; text-decoration: line-through;">${originalWord}</span>`;
                result += `<span style="background-color: #ddffdd;">${correctedWord}</span>`;
            }
        } else {
            result += originalWord;
        }
    }
    
    result += '</pre>';
    return result;
}

// Utility functions
function updateOriginalStats() {
    const text = document.getElementById('originalContent').value;
    const charCount = text.length;
    const wordCount = text.split(/\s+/).filter(word => word.length > 0).length;
  document.getElementById('originalStats').textContent = `{{ _('文字数') }}: ${charCount.toLocaleString()}, {{ _('単語数') }}: ${wordCount.toLocaleString()}`;
}

function updateCorrectedStats() {
    const text = document.getElementById('correctedContent').value;
    const charCount = text.length;
    const wordCount = text.split(/\s+/).filter(word => word.length > 0).length;
  document.getElementById('correctedStats').textContent = `{{ _('文字数') }}: ${charCount.toLocaleString()}, {{ _('単語数') }}: ${wordCount.toLocaleString()}`;
}

function updateSessionCost() {
  document.getElementById('sessionCostDisplay').textContent = `{{ _('現在のセッションコスト') }}: $${sessionCost.toFixed(5)} USD`;
}

function resetSessionCost() {
    sessionCost = 0.0;
    updateSessionCost();
    showSuccess(MSG.session_cost_reset);
}

function showSuccess(message) {
    // Simple toast notification
    const toast = document.createElement('div');
    toast.className = 'alert alert-success alert-dismissible fade show position-fixed';
    toast.style.top = '20px';
    toast.style.right = '20px';
    toast.style.zIndex = '9999';
    toast.innerHTML = `${message} <button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 5000);
}

function showError(message) {
    const toast = document.createElement('div');
    toast.className = 'alert alert-danger alert-dismissible fade show position-fixed';
    toast.style.top = '20px';
    toast.style.right = '20px';
    toast.style.zIndex = '9999';
    toast.innerHTML = `${message} <button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 8000);
}

// Defer DOM-dependent listener bindings until DOMContentLoaded
document.addEventListener('DOMContentLoaded', () => {
    const modelSelect = document.getElementById('modelSelect');
    if(modelSelect){
        modelSelect.addEventListener('change', function(){
            const model = this.value;
            const pricingInfo = {
                'gpt-4o': `${"{{ _('入力') }}"} $0.005 / 1K ${"{{ _('トークン') }}"} • ${"{{ _('出力') }}"} $0.015 / 1K ${"{{ _('トークン') }}"}`,
                'gpt-4o-mini': `${"{{ _('入力') }}"} $0.000150 / 1K ${"{{ _('トークン') }}"} • ${"{{ _('出力') }}"} $0.000600 / 1K ${"{{ _('トークン') }}"}`,
                'gpt-4-turbo': `${"{{ _('入力') }}"} $0.010 / 1K ${"{{ _('トークン') }}"} • ${"{{ _('出力') }}"} $0.030 / 1K ${"{{ _('トークン') }}"}`
            };
            const pricingEl = document.getElementById('pricingInfo');
            if(pricingEl) pricingEl.textContent = "{{ _('料金') }}: " + pricingInfo[model];
        });
        modelSelect.dispatchEvent(new Event('change'));
    }

    const showDiffCheckbox = document.getElementById('showDiff');
    if(showDiffCheckbox){
        showDiffCheckbox.addEventListener('change', function(){
            if(this.checked && originalText && correctedText){
                showDiff();
            } else {
                const diffDisplay = document.getElementById('diffDisplay');
                if(diffDisplay) diffDisplay.style.display = 'none';
            }
        });
    }
});

// Transcript history toggle
function toggleTranscriptHistory() {
    const mainContent = document.getElementById('mainContent');
    const historyContent = document.getElementById('transcriptHistoryContent');
    const userManagementContent = document.getElementById('userManagementContent');
    const mainButtons = document.getElementById('mainButtons');
    mainContent.style.display = 'none';
    userManagementContent.style.display = 'none';
    mainButtons.style.display = 'none';
    historyContent.style.display = 'block';
    loadTranscriptHistory();
    document.getElementById('backToMainBtn').style.display = 'inline-block';
}
// (Removed residual word list functions)

// User Management Functions
function toggleUserManagement() {
    const mainContent = document.getElementById('mainContent');
    const userManagementContent = document.getElementById('userManagementContent');
    const mainButtons = document.getElementById('mainButtons');
    mainContent.style.display = 'none';
    mainButtons.style.display = 'none';
    userManagementContent.style.display = 'block';
    document.getElementById('backToMainBtn').style.display = 'inline-block';
    loadUserData();
}

function showMainScreen() {
    const mainContent = document.getElementById('mainContent');
    const userManagementContent = document.getElementById('userManagementContent');
    const mainButtons = document.getElementById('mainButtons');
    mainContent.style.display = 'block';
    mainButtons.style.display = 'block';
    document.getElementById('backToMainBtn').style.display = 'none';
    userManagementContent.style.display = 'none';
    document.getElementById('transcriptHistoryContent').style.display = 'none';
}

function switchTab(tabType) {
    const userTab = document.getElementById('userTab');
    const roleTab = document.getElementById('roleTab');
    const userTabContent = document.getElementById('userTabContent');
    const roleTabContent = document.getElementById('roleTabContent');
    
    if (tabType === 'user') {
        userTab.classList.add('active');
        roleTab.classList.remove('active');
        userTabContent.classList.add('show', 'active');
        roleTabContent.classList.remove('show', 'active');
        loadUserData();
    } else {
        roleTab.classList.add('active');
        userTab.classList.remove('active');
        roleTabContent.classList.add('show', 'active');
        userTabContent.classList.remove('show', 'active');
        loadRoleData();
    }
}

function loadUserData() {
    // Load users from API
    fetch('/admin/api/users')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const tbody = document.getElementById('userTableBody');
                tbody.innerHTML = data.users.map(user => {
                    const statusLabel = user.is_active ? '{{ _('アクティブ') }}' : '{{ _('無効') }}';
                    return `
                    <tr>
                        <td>${user.id}</td>
                        <td>${user.username}</td>
                        <td>${user.email}</td>
                        <td><span class="badge ${user.role === 'Admin' ? 'bg-danger' : 'bg-primary'}">${user.role}</span></td>
                        <td>${user.last_login || '-'}</td>
                        <td><span class="badge ${user.is_active ? 'bg-success' : 'bg-secondary'}">${statusLabel}</span></td>
                        <td class="actions-cell text-nowrap">
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="editUser(${user.id})">{{ _('編集') }}</button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteUser(${user.id})">{{ _('削除') }}</button>
                        </td>
                    </tr>`;
                }).join('');
            } else {
                showError('ユーザーデータの読み込みに失敗しました: ' + data.error);
            }
        })
        .catch(error => {
            showError('ユーザーデータの読み込みに失敗しました: ' + error.message);
        });
}

function loadTranscriptHistory(){
    fetch('/transcripts/api/history')
        .then(r=>r.json())
        .then(data=>{
            const el = document.getElementById('transcriptHistoryList');
            if(!el) return;
            if(!data.success){ el.textContent = "{{ _('読み込みエラー') }}"; return; }
            if(data.transcripts.length === 0){ el.textContent = "{{ _('まだ議事録がありません') }}"; return; }
            el.innerHTML = data.transcripts.map(t => `
                <div class="border rounded p-2 mb-2">
                    <div><strong>${t.title}</strong></div>
                    <div class="text-muted">{{ _('作成日') }}: ${t.created_at || '-'} / {{ _('確定回数') }}: ${t.revision_count}</div>
                </div>
            `).join('');
        })
        .catch(err => {
            const el = document.getElementById('transcriptHistoryList');
            if(el) el.textContent = "{{ _('読み込みエラー') }}";
        });
}

function loadRoleData() {
    // Load roles from API
    fetch('/admin/api/roles')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const tbody = document.getElementById('roleTableBody');
                const roleNoDesc = "{{ _('説明なし') }}";
                const noPermLabel = "{{ _('権限なし') }}";
                tbody.innerHTML = data.roles.map(role => {
                    const permissions = [];
                    if (role.permissions.can_manage_users) permissions.push("{{ _('ユーザー管理') }}");
                    if (role.permissions.can_manage_roles) permissions.push("{{ _('ロール管理') }}");
                    if (role.permissions.can_view_all_transcripts) permissions.push("{{ _('全体閲覧') }}");
                    if (role.permissions.can_manage_wordlists) permissions.push("{{ _('辞書管理') }}");
                    if (role.permissions.can_use_api) permissions.push('API');
                    const permissionsHtml = permissions.length
                        ? permissions.map(p => `<span class="badge bg-info me-1 mb-1">${p}</span>`).join('')
                        : `<span class="badge bg-secondary">${noPermLabel}</span>`;
                    
                    return `
                        <tr>
                            <td><strong>${role.name}</strong></td>
                            <td>${role.description ? role.description : roleNoDesc}</td>
                            <td class="permissions-cell">${permissionsHtml}</td>
                            <td>${role.user_count}</td>
                            <td>${role.created_at}</td>
                            <td class="actions-cell text-nowrap">
                                <button class="btn btn-sm btn-outline-primary me-1" onclick="editRole(${role.id})">{{ _('編集') }}</button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteRole(${role.id})">{{ _('削除') }}</button>
                            </td>
                        </tr>
                    `;
                }).join('');
            } else {
                showError('ロールデータの読み込みに失敗しました: ' + data.error);
            }
        })
        .catch(error => {
            showError('ロールデータの読み込みに失敗しました: ' + error.message);
        });
}

// User/Role management functions
// Modal logic wrapped after DOM ready to avoid early reference errors
let userModalInstance = null;
let roleModalInstance = null;
document.addEventListener('DOMContentLoaded',()=>{
    // Pre-cache modal elements lazily when first needed
});

function ensureUserModal(){
        if(!userModalInstance){
                const el=document.getElementById('userModal');
                if(!window.bootstrap){ console.warn('Bootstrap JS not loaded'); return; }
                userModalInstance = new bootstrap.Modal(el);
        }
}

function populateRoleSelect(){
    fetch('/admin/api/roles')
        .then(r=>r.json())
        .then(data=>{
            if(!data.success) return;
            const sel=document.getElementById('roleSelect');
            sel.innerHTML = '<option value="">(default)</option>' + data.roles.map(r=>`<option value="${r.id}">${r.name}</option>`).join('');
        });
}

function addUser(){
    ensureUserModal();
    populateRoleSelect();
        document.getElementById('userModalTitle').textContent="{{ _('新規ユーザー追加') }}";
        document.getElementById('saveUserBtn').textContent="{{ _('作成') }}";
        document.getElementById('passwordHelp').textContent="{{ _('必須') }}";
    document.getElementById('userForm').reset();
    document.getElementById('userIdField').value='';
    document.getElementById('passwordGroup').style.display='block';
    userModalInstance.show();
    document.getElementById('saveUserBtn').onclick = submitCreateUser;
}

function editUser(userId){
    ensureUserModal();
    populateRoleSelect();
    fetch(`/admin/api/users/${userId}`)
        .then(r=>r.json())
        .then(data=>{
            if(!data.success){ showError(MSG.load_failed); return; }
            const u=data.user;
            document.getElementById('userModalTitle').textContent="{{ _('ユーザー編集') }}";
            document.getElementById('saveUserBtn').textContent="{{ _('更新') }}";
            document.getElementById('usernameField').value=u.username;
            document.getElementById('emailField').value=u.email;
            document.getElementById('roleSelect').value = u.role_id || '';
            document.getElementById('isActiveField').checked = !!u.is_active;
            document.getElementById('isVerifiedField').checked = !!u.is_verified;
            document.getElementById('userIdField').value=u.id;
            document.getElementById('passwordField').value='';
            document.getElementById('passwordHelp').textContent="{{ _('空欄の場合は変更されません') }}";
            document.getElementById('passwordGroup').style.display='block';
            userModalInstance.show();
            document.getElementById('saveUserBtn').onclick = submitUpdateUser;
        });
}

function collectUserPayload(isCreate){
    const payload={
        username: document.getElementById('usernameField').value.trim(),
        email: document.getElementById('emailField').value.trim(),
        role_id: document.getElementById('roleSelect').value || null,
        is_active: document.getElementById('isActiveField').checked,
        is_verified: document.getElementById('isVerifiedField').checked
    };
    const pw=document.getElementById('passwordField').value;
    if(isCreate || pw){ payload.password = pw; }
    return payload;
}

function submitCreateUser(){
    const payload=collectUserPayload(true);
    if(!payload.username || !payload.email || !payload.password){ showError('必須項目が未入力'); return; }
    fetch('/admin/api/users',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)})
        .then(r=>r.json())
    .then(data=>{ if(data.success){ showSuccess(MSG.user_created); userModalInstance.hide(); loadUserData(); } else { showError(data.error||'Error'); } });
}

function submitUpdateUser(){
    const id=document.getElementById('userIdField').value;
    const payload=collectUserPayload(false);
    fetch(`/admin/api/users/${id}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)})
        .then(r=>r.json())
    .then(data=>{ if(data.success){ showSuccess(MSG.user_updated); userModalInstance.hide(); loadUserData(); } else { showError(data.error||'Error'); } });
}

function deleteUser(userId) {
    if (!confirm("{{ _('ユーザー') }} " + userId + " {{ _('を削除しますか？この操作は取り消せません。') }}")) {
        return;
    }
    
    fetch('/admin/api/users/' + userId, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess(data.message);
            loadUserData();
        } else {
            showError('{{ _('ユーザー削除に失敗しました') }}: ' + data.error);
        }
    })
    .catch(error => {
    showError('{{ _('ユーザー削除に失敗しました') }}: ' + error.message);
    });
}

function ensureRoleModal(){
    if(!roleModalInstance){
        const el=document.getElementById('roleModal');
        if(!window.bootstrap){ console.warn('Bootstrap JS not loaded'); return; }
        roleModalInstance = new bootstrap.Modal(el);
    }
}

function addRole(){
    ensureRoleModal();
    document.getElementById('roleForm').reset();
    document.getElementById('roleIdField').value='';
        document.getElementById('roleModalTitle').textContent="{{ _('新規ロール追加') }}";
        document.getElementById('saveRoleBtn').textContent="{{ _('作成') }}";
    roleModalInstance.show();
    document.getElementById('saveRoleBtn').onclick = submitCreateRole;
}

function editRole(roleId){
    ensureRoleModal();
    fetch('/admin/api/roles/' + roleId)
        .then(r=>r.json())
        .then(data=>{
            if(!data.success){ showError(MSG.load_failed); return; }
            const r=data.role;
            document.getElementById('roleModalTitle').textContent="{{ _('ロール編集') }}";
            document.getElementById('saveRoleBtn').textContent="{{ _('更新') }}";
            document.getElementById('roleIdField').value=r.id;
            document.getElementById('roleNameField').value=r.name;
            document.getElementById('roleDescriptionField').value=r.description||'';
            document.getElementById('permManageUsers').checked = r.permissions.can_manage_users;
            document.getElementById('permManageRoles').checked = r.permissions.can_manage_roles;
            document.getElementById('permViewAll').checked = r.permissions.can_view_all_transcripts;
            document.getElementById('permUseApi').checked = r.permissions.can_use_api;
            roleModalInstance.show();
            document.getElementById('saveRoleBtn').onclick = submitUpdateRole;
        });
}

function collectRolePayload(){
    return {
        name: document.getElementById('roleNameField').value.trim(),
        description: document.getElementById('roleDescriptionField').value.trim(),
        can_manage_users: document.getElementById('permManageUsers').checked,
        can_manage_roles: document.getElementById('permManageRoles').checked,
        can_view_all_transcripts: document.getElementById('permViewAll').checked,
        can_use_api: document.getElementById('permUseApi').checked
    };
}

function submitCreateRole(){
    const payload=collectRolePayload();
        if(!payload.name){ showError('Role name required'); return; }
    fetch('/admin/api/roles',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)})
        .then(r=>r.json())
        .then(data=>{ if(data.success){ showSuccess(MSG.role_created); roleModalInstance.hide(); loadRoleData(); } else { showError(data.error||'Error'); } });
}

function submitUpdateRole(){
    const id=document.getElementById('roleIdField').value;
    const payload=collectRolePayload();
    fetch('/admin/api/roles/' + id,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)})
        .then(r=>r.json())
        .then(data=>{ if(data.success){ showSuccess(MSG.role_updated); roleModalInstance.hide(); loadRoleData(); } else { showError(data.error||'Error'); } });
}

function deleteRole(roleId) {
    if (!confirm("{{ _('ロール') }} " + roleId + " {{ _('を削除しますか？この操作は取り消せません。') }}")) {
        return;
    }
    
    fetch('/admin/api/roles/' + roleId, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess(data.message);
            loadRoleData();
        } else {
            showError('{{ _('ロール削除に失敗しました') }}: ' + data.error);
        }
    })
    .catch(error => {
    showError('{{ _('ロール削除に失敗しました') }}: ' + error.message);
    });
}

// Resize functionality for left panel
let isResizing = false;

document.getElementById('resizeHandle').addEventListener('mousedown', function(e) {
    isResizing = true;
    document.body.style.cursor = 'col-resize';
    document.body.style.userSelect = 'none';
    
    document.addEventListener('mousemove', handleResize);
    document.addEventListener('mouseup', stopResize);
});

function handleResize(e) {
    if (!isResizing) return;
    
    const leftPanel = document.getElementById('leftPanel');
    const container = leftPanel.parentElement;
    const containerRect = container.getBoundingClientRect();
    const newWidth = e.clientX - containerRect.left;
    
    // Set minimum and maximum width constraints
    const minWidth = 250;
    const maxWidth = containerRect.width * 0.5; // Maximum 50% of container width
    
    if (newWidth >= minWidth && newWidth <= maxWidth) {
        leftPanel.style.width = newWidth + 'px';
    }
}

function stopResize() {
    isResizing = false;
    document.body.style.cursor = '';
    document.body.style.userSelect = '';
    
    document.removeEventListener('mousemove', handleResize);
    document.removeEventListener('mouseup', stopResize);
}
</script>
{% endblock %}